trigger:
- main

pool: 
  name: 'binet-window-agent'

steps:
# 第一步：打包网站文件
- task: ArchiveFiles@2
  displayName: '打包网站文件'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/website.zip'

# 第二步：发布成品（保留这个步骤用于记录和备份）
- task: PublishBuildArtifacts@1
  displayName: '发布成品'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/website.zip'
    artifactName: 'website'

# 第三步：部署到指定IIS路径
- task: PowerShell@2
  displayName: '部署到IIS项目目录'
  inputs:
    targetType: 'inline'
    script: |
      # 定义路径
      $projectPath = "C:\inetpub\wwwroot\project3"
      $zipFile = "$(Build.ArtifactStagingDirectory)/website.zip"
      
      Write-Host "🎯 开始部署到: $projectPath"
      
      # 检查并创建项目目录（如果不存在）
      if (-not (Test-Path $projectPath)) {
          Write-Host "📁 创建项目目录: $projectPath"
          New-Item -ItemType Directory -Path $projectPath -Force
          Write-Host "✅ 目录创建成功"
      } else {
          Write-Host "📁 项目目录已存在，准备更新..."
      }
      
      # 停止IIS网站（如果正在运行）
      Write-Host "⏸️  检查并停止网站..."
      $websiteName = "project3"
      $websiteExists = Get-IISSite -Name $websiteName -ErrorAction SilentlyContinue
      
      if ($websiteExists) {
          Stop-IISSite -Name $websiteName -Confirm:$false
          Write-Host "✅ 网站已停止"
      }
      
      # 清空目标目录（确保干净部署）
      Write-Host "🧹 清理旧文件..."
      Remove-Item "$projectPath\*" -Recurse -Force -ErrorAction SilentlyContinue
      
      # 解压文件到项目目录
      Write-Host "📦 解压文件到项目目录..."
      Add-Type -AssemblyName System.IO.Compression.FileSystem
      [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $projectPath, $true)
      
      # 配置IIS网站（首次部署时）
      if (-not $websiteExists) {
          Write-Host "🌐 首次部署，配置IIS网站..."
          
          # 创建IIS应用程序池
          New-WebAppPool -Name "project3AppPool" -Force
          Set-ItemProperty "IIS:\AppPools\project3AppPool" -Name "managedRuntimeVersion" -Value ""
          Set-ItemProperty "IIS:\AppPools\project3AppPool" -Name "enable32BitAppOnWin64" -Value $false
          
          # 创建IIS网站
          New-IISSite -Name "project3" -BindingInformation "*:80:project3" -PhysicalPath $projectPath -ApplicationPool "project3AppPool" -Force
          Write-Host "✅ IIS网站创建成功"
      } else {
          # 重启网站（后续更新时）
          Write-Host "🔄 重启网站..."
          Start-IISSite -Name $websiteName
          Write-Host "✅ 网站已启动"
      }
      
      Write-Host "🎉 部署完成！"
      Write-Host "📊 部署信息："
      Write-Host "   本地访问: http://localhost/project3"
      Write-Host "   外部访问: http://20.243.10.36/project3"
      Write-Host "   文件路径: $projectPath"