trigger:
- main

pool: 
  name: 'binet-window-agent'

steps:
# ç¬¬ä¸€æ­¥ï¼šæ‰“åŒ…ç½‘ç«™æ–‡ä»¶
- task: ArchiveFiles@2
  displayName: 'æ‰“åŒ…ç½‘ç«™æ–‡ä»¶'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/website.zip'

# ç¬¬äºŒæ­¥ï¼šå‘å¸ƒæˆå“ï¼ˆä¿ç•™è¿™ä¸ªæ­¥éª¤ç”¨äºè®°å½•å’Œå¤‡ä»½ï¼‰
- task: PublishBuildArtifacts@1
  displayName: 'å‘å¸ƒæˆå“'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/website.zip'
    artifactName: 'website'

# ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åˆ°æŒ‡å®šIISè·¯å¾„
- task: PowerShell@2
  displayName: 'éƒ¨ç½²åˆ°IISé¡¹ç›®ç›®å½•'
  inputs:
    targetType: 'inline'
    script: |
      # å®šä¹‰è·¯å¾„
      $projectPath = "C:\inetpub\wwwroot\project3"
      $zipFile = "$(Build.ArtifactStagingDirectory)/website.zip"
      
      Write-Host "ğŸ¯ å¼€å§‹éƒ¨ç½²åˆ°: $projectPath"
      
      # æ£€æŸ¥å¹¶åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      if (-not (Test-Path $projectPath)) {
          Write-Host "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•: $projectPath"
          New-Item -ItemType Directory -Path $projectPath -Force
          Write-Host "âœ… ç›®å½•åˆ›å»ºæˆåŠŸ"
      } else {
          Write-Host "ğŸ“ é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œå‡†å¤‡æ›´æ–°..."
      }
      
      # åœæ­¢IISç½‘ç«™ï¼ˆå¦‚æœæ­£åœ¨è¿è¡Œï¼‰
      Write-Host "â¸ï¸  æ£€æŸ¥å¹¶åœæ­¢ç½‘ç«™..."
      $websiteName = "project3"
      $websiteExists = Get-IISSite -Name $websiteName -ErrorAction SilentlyContinue
      
      if ($websiteExists) {
          Stop-IISSite -Name $websiteName -Confirm:$false
          Write-Host "âœ… ç½‘ç«™å·²åœæ­¢"
      }
      
      # æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆç¡®ä¿å¹²å‡€éƒ¨ç½²ï¼‰
      Write-Host "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
      Remove-Item "$projectPath\*" -Recurse -Force -ErrorAction SilentlyContinue
      
      # è§£å‹æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
      Write-Host "ğŸ“¦ è§£å‹æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•..."
      Add-Type -AssemblyName System.IO.Compression.FileSystem
      [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $projectPath, $true)
      
      # é…ç½®IISç½‘ç«™ï¼ˆé¦–æ¬¡éƒ¨ç½²æ—¶ï¼‰
      if (-not $websiteExists) {
          Write-Host "ğŸŒ é¦–æ¬¡éƒ¨ç½²ï¼Œé…ç½®IISç½‘ç«™..."
          
          # åˆ›å»ºIISåº”ç”¨ç¨‹åºæ± 
          New-WebAppPool -Name "project3AppPool" -Force
          Set-ItemProperty "IIS:\AppPools\project3AppPool" -Name "managedRuntimeVersion" -Value ""
          Set-ItemProperty "IIS:\AppPools\project3AppPool" -Name "enable32BitAppOnWin64" -Value $false
          
          # åˆ›å»ºIISç½‘ç«™
          New-IISSite -Name "project3" -BindingInformation "*:80:project3" -PhysicalPath $projectPath -ApplicationPool "project3AppPool" -Force
          Write-Host "âœ… IISç½‘ç«™åˆ›å»ºæˆåŠŸ"
      } else {
          # é‡å¯ç½‘ç«™ï¼ˆåç»­æ›´æ–°æ—¶ï¼‰
          Write-Host "ğŸ”„ é‡å¯ç½‘ç«™..."
          Start-IISSite -Name $websiteName
          Write-Host "âœ… ç½‘ç«™å·²å¯åŠ¨"
      }
      
      Write-Host "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
      Write-Host "ğŸ“Š éƒ¨ç½²ä¿¡æ¯ï¼š"
      Write-Host "   æœ¬åœ°è®¿é—®: http://localhost/project3"
      Write-Host "   å¤–éƒ¨è®¿é—®: http://20.243.10.36/project3"
      Write-Host "   æ–‡ä»¶è·¯å¾„: $projectPath"