trigger:
- main

pool: 
  name: 'binet-window-agent'

steps:
# ç¬¬ä¸€æ­¥ï¼šæ‰“åŒ…ç½‘ç«™æ–‡ä»¶
- task: ArchiveFiles@2
  displayName: 'æ‰“åŒ…ç½‘ç«™æ–‡ä»¶'
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)'
    includeRootFolder: false
    archiveFile: '$(Build.ArtifactStagingDirectory)/website.zip'

# ç¬¬äºŒæ­¥ï¼šå‘å¸ƒæˆå“
- task: PublishBuildArtifacts@1
  displayName: 'å‘å¸ƒæˆå“'
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/website.zip'
    artifactName: 'website'

# ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åˆ°æŒ‡å®šIISè·¯å¾„
- task: PowerShell@2
  displayName: 'éƒ¨ç½²åˆ°IISé¡¹ç›®ç›®å½•'
  inputs:
    targetType: 'inline'
    script: |
      # å®šä¹‰è·¯å¾„
      $projectPath = "C:\inetpub\wwwroot\project3"
      $zipFile = "$(Build.ArtifactStagingDirectory)/website.zip"
      
      Write-Host "ğŸ¯ å¼€å§‹éƒ¨ç½²åˆ°: $projectPath"
      
      # æ£€æŸ¥å¹¶åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      if (-not (Test-Path $projectPath)) {
          Write-Host "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•: $projectPath"
          New-Item -ItemType Directory -Path $projectPath -Force
          Write-Host "âœ… ç›®å½•åˆ›å»ºæˆåŠŸ"
      } else {
          Write-Host "ğŸ“ é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œå‡†å¤‡æ›´æ–°..."
      }
      
      # æ¸…ç©ºç›®æ ‡ç›®å½•ï¼ˆç¡®ä¿å¹²å‡€éƒ¨ç½²ï¼‰
      Write-Host "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
      Remove-Item "$projectPath\*" -Recurse -Force -ErrorAction SilentlyContinue
      
      # è§£å‹æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•ï¼ˆä¿®å¤è§£å‹å‚æ•°ï¼‰
      Write-Host "ğŸ“¦ è§£å‹æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•..."
      Add-Type -AssemblyName System.IO.Compression.FileSystem
      try {
          # æ–¹æ³•1ï¼šä½¿ç”¨æ­£ç¡®çš„è§£å‹å‚æ•°
          [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile, $projectPath)
          Write-Host "âœ… æ–‡ä»¶è§£å‹æˆåŠŸ"
      } catch {
          Write-Host "âš ï¸  æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
          # æ–¹æ³•2ï¼šä½¿ç”¨ .NET Core æ–¹å¼
          Expand-Archive -Path $zipFile -DestinationPath $projectPath -Force
          Write-Host "âœ… æ–‡ä»¶è§£å‹æˆåŠŸï¼ˆæ–¹æ³•2ï¼‰"
      }
      
      # é…ç½®IISç½‘ç«™ï¼ˆæ£€æŸ¥å¹¶åˆ›å»ºï¼‰
      Write-Host "ğŸŒ é…ç½®IISç½‘ç«™..."
      $websiteName = "project3"
      
      # å¯¼å…¥IISæ¨¡å—
      Import-Module WebAdministration
      
      # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å­˜åœ¨
      $websiteExists = Get-Item "IIS:\Sites\$websiteName" -ErrorAction SilentlyContinue
      
      if (-not $websiteExists) {
          Write-Host "é¦–æ¬¡éƒ¨ç½²ï¼Œåˆ›å»ºIISç½‘ç«™..."
          
          # åˆ›å»ºåº”ç”¨ç¨‹åºæ± 
          $appPoolName = "project3AppPool"
          if (-not (Test-Path "IIS:\AppPools\$appPoolName")) {
              New-WebAppPool -Name $appPoolName
              Write-Host "âœ… åº”ç”¨ç¨‹åºæ± åˆ›å»ºæˆåŠŸ"
          }
          
          # åˆ›å»ºç½‘ç«™
          New-Website -Name $websiteName -PhysicalPath $projectPath -ApplicationPool $appPoolName -Port 80 -Force
          Write-Host "âœ… IISç½‘ç«™åˆ›å»ºæˆåŠŸ"
      } else {
          Write-Host "ç½‘ç«™å·²å­˜åœ¨ï¼Œç¡®ä¿è¿è¡Œä¸­..."
          # ç¡®ä¿ç½‘ç«™æ­£åœ¨è¿è¡Œ
          Start-Website -Name $websiteName
      }
      
      Write-Host "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
      Write-Host "ğŸ“Š éƒ¨ç½²ä¿¡æ¯ï¼š"
      Write-Host "   æœ¬åœ°è®¿é—®: http://localhost/project3"
      Write-Host "   å¤–éƒ¨è®¿é—®: http://20.243.10.36/project3"
      Write-Host "   æ–‡ä»¶è·¯å¾„: $projectPath"
      
      # æ˜¾ç¤ºéƒ¨ç½²çš„æ–‡ä»¶
      Write-Host "ğŸ“„ éƒ¨ç½²çš„æ–‡ä»¶ï¼š"
      Get-ChildItem $projectPath -Recurse | ForEach-Object { Write-Host "   - $($_.Name)" }